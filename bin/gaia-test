#!/bin/bash

SELF=`basename $0`

#
# Configure gaia location
#
if [ "$1" = "" ] ; then
  if [ "$GAIADIR" = "" ] ; then
    GAIADIR="$FXOS_HOME/gaia-master"
  fi
elif [ -d "$1" ] ; then
  GAIADIR="$1"
else
  GAIADIR="$FXOS_HOME/gaia-$1"
fi

if [ ! -d "$GAIADIR" ] ; then
  echo "$SELF: '$GAIADIR' is not a directory!"
  exit 1
fi

#
# Configure firefox test binary
#
BASE_FIREFOX='firefox'
if [ "$2" != "" ] ; then
  BASE_FIREFOX="$2"
fi

FIREFOX=`which $BASE_FIREFOX`
if [ ! -x "$FIREFOX" ] ; then
  echo "$SELF: Unable to find an executable '$BASE_FIREFOX' in path!"
  exit 1
fi

#
# Verify firefox version is new enough
#
VERSION=`$FIREFOX --version | awk '{print $3}'`
REQ_VERSION='22'
if expr "$VERSION" \< "$REQ_VERSION" >/dev/null ; then
  echo "$SELF: Firefox is only version $VERSION; use $REQ_VERSION or newer."
  exit 1
fi

echo "$SELF: Using gaia at '$GAIADIR'."
echo "$SELF: Using Firefox $VERSION at '$FIREFOX'."

#
# Verify additional dependencies are installed
#
NODE=`which node`
NPM=`which npm`
if [ ! -x "$NODE" ] ; then
  echo "$SELF: Unable to find node; please install node.js."
  exit 1
elif [ ! -x "$NPM" ] ; then
  echo "$SELF: Unable to find npm; please install npm."
  exit 1
fi

cd $GAIADIR

#
# Verify the profile is ready
#
PROFILE="$GAIADIR/profile-debug"
if [ ! -d "$PROFILE" ] ; then
  echo "$SELF: Building the debug profile."
  DEBUG=1 make
fi

#
# Launch firefox
#
$FIREFOX --no-remote -profile "$PROFILE" http://test-agent.gaiamobile.org:8080/ &
cleanup() {
  echo "$SELF: Stopping firefox on exit."
  kill "%1"
}
trap cleanup EXIT

#
# Launch the test agent
#
make test-agent-server
